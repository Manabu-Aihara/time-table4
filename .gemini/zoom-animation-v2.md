# タイムラインのズームアニメーション機能

## 1. 要件定義

### 1.1. 背景・目的

各所属のメンバーのタスクやイベントを効率的・視覚的に充実させるため、タイムラインのズームアニメーション機能を追加します。これにより、ユーザーは表示粒度を自由に調整し、過密なスケジュールでも個々のイベントを明確に確認できるようになります。

### 1.2. 機能概要

- タイムラインの表示範囲を、アイテムのドラッグイベントを検知し、タイムラインの表示範囲を動的に変更することで実現します。

### 1.3. 機能要件

#### 1.3.1. ズーム操作

- ズームイン・ズームアウトの操作は、ドラッグ操作を検知し、タイムラインの表示粒度を動的に変更することで実現します。
- ズームの度合いは、ドラッグの距離に応じて調整します。

#### 1.3.2. ズームアニメーション

- ズームイン・ズームアウト時に、表示範囲が滑らかに変化するアニメーションを適用します。
- アニメーションの速度やイージングは、ユーザーが心地よく感じられるように調整します。
- アニメーションの開始・終了時に、適切なコールバック関数を呼び出すことで、他の処理と連携できるようにします。
- アニメーションの状態（開始、進行中、終了）を管理し、必要に応じてUIの更新や他のロジックをトリガーできるようにします。
- アニメーション中にユーザーが別の操作を行った場合、アニメーションを中断し、新しい操作を優先します。

### 1.4. 非機能要件

- **ユーザビリティ:** ズーム操作は、直感的で分かりやすいこと。
- **互換性:** 主要なブラウザ（Chrome, Firefox, Safari, Edge）で正常に動作すること。
- **拡張性:** 将来的に関連機能を追加しやすいように設計する。
- **テスト:** 機能に関する単体テスト、結合テストを実装する。
- **ドキュメント:** 仕様、設計、実装に関するドキュメントを整備する。


## 2. 機能設計

### 2.1. アーキテクチャ

1.  **ズームロジック:**

- タイムラインの表示範囲を計算するロジックを`src/lib/timelineZoomUtils.ts`にヘルパー関数として実装します。この関数は、現在の表示範囲とドラッグによる移動距離を受け取り、新しい`visibleTimeStart`と`visibleTimeEnd`を返します。また、ズームの方向（イン/アウト）と度合いを決定します。

- 必要に応じて、`src/tests/timelineZoomUtils.spec.ts`にテストコードを記述します。

2.  **状態管理:**

- 現在のタイムラインの表示範囲 (`visibleTimeStart`, `visibleTimeEnd`) と、現在のズームレベルを管理する状態を `TimelineComponent` またはその親コンポーネントで保持します。
- Reactの `useState` または `useReducer` を利用します。

3.  **カスタムドラッグ操作の実装:**

- `TimelineComponent`内でカスタムドラッグ操作を実装し、タイムラインの表示範囲を動的に変更できるようにします。

- ドラッグイベント（`onMouseDown`, `onMouseMove`, `onMouseUp`）をリッスンし、ドラッグの開始位置と移動量に基づいて表示範囲を計算します。

- これらのマウスイベントを管理し、「ドラッグ操作中か」「ドラッグ開始位置はどこか」といった状態を管理するカスタムフック（例: useTimelineDragZoom）を作成します。

- ドラッグ中のマウスの移動距離（横方向のピクセル数）を計算し、その移動距離に応じてズームの度合いを決定します。

- 計算されたズームの度合いに基づき、タイムラインの visibleTimeStart と visibleTimeEnd を更新して、表示を動的に変更します。

- タイムライン既存の機能であるスクロールを通常使えるようにするため、`onTimeChange`イベントハンドラを実装します。

### 2.2. 実装詳細

- **対象コンポーネント:** `/home/nabu_dvl/workspace/time-table4/src/components/pages/TimelineComponent.tsx`

- **ライブラリの活用:**

- `react-calendar-timeline-v3` の `Timeline` コンポーネントが受け取る `visibleTimeStart` および `visibleTimeEnd` プロパティを動的に変更することで、タイムラインの表示範囲を制御し、ズームを実現します。

- `visibleTimeStart` および `visibleTimeEnd`を設定すると、タイムラインのスクロールができなくなるので、[React Calendar Timeline](https://github.com/namespace-ee/react-calendar-timeline)に基づいて、`onTimeChange` Timelineプロパティを定義し、スクロールイベントを処理します。

- `onTimeChange` プロパティは、`visibleTimeStart` と `visibleTimeEnd` の変更を検知し、タイムラインの表示範囲を更新します。この関数は、`visibleTimeStart` と `visibleTimeEnd` を引数として受け取ります。これにより、ユーザーがタイムラインをスクロールした際に、表示範囲が適切に更新されます。この関数は、`Timeline` コンポーネントの `onTimeChange` プロパティに渡されます。このプロパティは、`onTimeChange` イベントハンドラとして機能し、タイムラインのスクロールやズーム操作によって発生する表示範囲の変更を処理します。`onTimeChange` イベントハンドラは、タイムラインの表示範囲が変更されたときに呼び出されます。

- ズームアニメーションは、CSS TransitionまたはJavaScriptアニメーションライブラリ（例: React Springなど）を使用して滑らかに表現します。

- `useTimelineDragZoom` カスタムフックは、ドラッグ操作の状態管理とズーム計算ロジックをカプセル化し、`TimelineComponent` から再利用可能にします。

- **ファイル構成案:**
    - `src/hooks/useTimelineDragZoom.ts`: ドラッグ操作の状態とズーム計算ロジックを管理するカスタムフック

    - `src/lib/timelineZoomUtils.ts`: ズームレベルに応じた表示期間を計算するユーティリティ関数

    - `src/tests/timelineZoomUtils.spec.ts`: 上記ユーティリティのテスト

    - `src/components/pages/TimelineComponent.tsx`: タイムラインコンポーネント
